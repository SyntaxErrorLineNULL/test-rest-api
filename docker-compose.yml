version: '3.7'
volumes:
    logs:
        driver: local
services:
    php-fpm:
        container_name: app_php_fpm
        build:
            dockerfile: php-fpm/Dockerfile
            context: docker
            cache_from:
                - ${REGISTRY:-localhost}/app-php-fpm
        volumes:
            - ./:/app
        links:
            - app-db
    php-cli:
        container_name: app_php_cli
        build:
            dockerfile: php-cli/Dockerfile
            context: docker
            cache_from:
                - ${REGISTRY:-localhost}/app-php-cli
        volumes:
            - ./:/app
        links:
            - app-db
    app-db:
        container_name: app_postgres
        image: postgres:13.1-alpine
        environment:
            POSTGRES_USER: ${DB_USER}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
            POSTGRES_DB: ${DB_NAME}
        volumes:
            - ./postgres-data:/var/lib/postgresql/data
        ports:
            - "54321:5432"