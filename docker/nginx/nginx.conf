# Nginx configuration
user nginx;

# default log
error_log  /var/log/nginx/error.log warn;

http {

    # max upload size
    client_max_body_size 10M;
    client_body_buffer_size 256K;
    large_client_header_buffers 4 64k;
    proxy_read_timeout 600s;

    # This is the main geonode conf
    charset utf-8;

    server {
        # serve port and name
        listen 80;
        server_name test;

        # error and access log
        access_log  /var/log/nginx/access.log  main;
        error_log /var/log/nginx/error.log;

        # root file
        root /app/public;
        index index.php

        location / {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Allow-Methods' 'GET,POST,PUT,DELETE,HEAD,OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Origin,Content-Type,Accept,Authorization,X-Features' always;
                add_header 'Content-Type' 'text/plain charset=UTF-8';
                add_header 'Content-Length' 0;
                return 200;
            }
            try_files $uri /index.php?$args;
        }

        location ~ \.php$ {
            set $upstream api-php-fpm:9000;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass $upstream;
            fastcgi_index index.php;
            fastcgi_read_timeout 300;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
        }
    }
}